"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[471],{471:function(e,t,o){o.d(t,{SubscriptionProvider:function(){return c},m:function(){return p}});var s=o(7437),r=o(2265),n=o(7124);let a={notes_per_month:2,max_saved_notes:3,max_text_length:5e3},i={notes_generation:!0,quizzes:!1,youtube_support:!0,ppt_support:!1,export:!1,copy_paste:!0,upload_video:!1,priority_generation:!1},l={notes_generated:0,video_notes_count:0,file_notes_count:0,text_notes_count:0,total_saved_notes:0,month_year:new Date().toISOString().slice(0,7)},u=(0,r.createContext)({planId:"free",planName:"Free",features:i,limits:a,usage:l,isLoading:!0,canGenerateNotes:!1,canSaveNotes:!1,canUseQuizzes:!1,canUploadPPT:!1,canUseYouTube:!1,canUploadVideo:!1,canExportNotes:!1,hasPriorityProcessing:!1,refreshUsage:async()=>{},showUpgradeModal:()=>{}});function c(e){let{children:t}=e,{user:o,supabase:c}=(0,n.$)(),[p,d]=(0,r.useState)("free"),[g,_]=(0,r.useState)("Free"),[f,h]=(0,r.useState)(i),[b,m]=(0,r.useState)(a),[y,x]=(0,r.useState)(l),[w,v]=(0,r.useState)(!0),S={free:{name:"Free",features:{notes_generation:!0,quizzes:!1,youtube_support:!0,ppt_support:!1,export:!1,copy_paste:!0,upload_video:!1,priority_generation:!1},limits:{notes_per_month:2,max_saved_notes:3,max_text_length:5e3}},student:{name:"Student",features:{notes_generation:!0,quizzes:!0,youtube_support:!0,ppt_support:!0,export:!0,copy_paste:!0,upload_video:!0,priority_generation:!1},limits:{notes_per_month:10,max_saved_notes:12,max_text_length:1e4}},pro:{name:"Pro",features:{notes_generation:!0,quizzes:!0,youtube_support:!0,ppt_support:!0,export:!0,copy_paste:!0,upload_video:!0,priority_generation:!0},limits:{notes_per_month:-1,max_saved_notes:50,max_text_length:15e3}}},D=async()=>{if(!o){v(!1);return}try{let{data:e,error:t}=await c.from("subscription_plans").select("*").limit(1),s="free";if(!t&&e){let{data:e,error:t}=await c.from("user_subscriptions").select("\n            plan_id,\n            subscription_plans (\n              name,\n              features,\n              limits\n            )\n          ").eq("user_id",o.id).eq("status","active").single();if(!t&&e){s=e.plan_id;let t=e.subscription_plans;_(t.name),h(t.features),m(t.limits)}}if(!e||"free"===s){let e=S[s];_(e.name),h(e.features),m(e.limits)}d(s),await B()}catch(t){console.error("[Subscription] Error fetching subscription data:",t);let e=S.free;d("free"),_(e.name),h(e.features),m(e.limits)}finally{v(!1)}},B=async()=>{if(o)try{let e=new Date().toISOString().slice(0,7),{data:t,error:s}=await c.from("user_usage").select("*").eq("user_id",o.id).eq("month_year",e).single();!s&&t?x(t):x({notes_generated:0,video_notes_count:0,file_notes_count:0,text_notes_count:0,total_saved_notes:0,month_year:e})}catch(e){console.error("[Subscription] Error fetching usage data:",e)}},z=async()=>{if(o)try{let{data:{session:e}}=await c.auth.getSession(),t=null==e?void 0:e.access_token;if(!t){console.error("[Subscription] No authentication token available for refresh");return}let o=await fetch("/api/refresh-usage",{method:"POST",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"}});if(o.ok){let e=await o.json();e.success&&e.data?(x(e.data),console.log("[Subscription] Usage refreshed successfully:",e.data)):(console.warn("[Subscription] Refresh API succeeded but no data returned"),await B())}else console.error("[Subscription] Refresh API failed, falling back to local fetch"),await B()}catch(e){console.error("[Subscription] Error refreshing usage:",e),await B()}};(0,r.useEffect)(()=>{o&&(D(),B())},[o]),(0,r.useEffect)(()=>{let e=()=>{o&&(console.log("[Subscription] Window focused, refreshing usage data..."),B())},t=()=>{o&&"visible"===document.visibilityState&&(console.log("[Subscription] Page became visible, refreshing usage data..."),B())};return window.addEventListener("focus",e),document.addEventListener("visibilitychange",t),()=>{window.removeEventListener("focus",e),document.removeEventListener("visibilitychange",t)}},[o]);let E=f.notes_generation&&(-1===b.notes_per_month||y.notes_generated<b.notes_per_month),I=y.total_saved_notes<b.max_saved_notes,A=f.quizzes,C=f.ppt_support,P=f.youtube_support,k=f.upload_video,U=f.export,R=f.priority_generation;return(0,s.jsx)(u.Provider,{value:{planId:p,planName:g,features:f,limits:b,usage:y,isLoading:w,canGenerateNotes:E,canSaveNotes:I,canUseQuizzes:A,canUploadPPT:C,canUseYouTube:P,canUploadVideo:k,canExportNotes:U,hasPriorityProcessing:R,refreshUsage:z,showUpgradeModal:()=>{window.location.href="/pricing"}},children:t})}function p(){let e=(0,r.useContext)(u);if(!e)throw Error("useSubscription must be used within a SubscriptionProvider");return e}},7124:function(e,t,o){o.d(t,{SupabaseProvider:function(){return d},$:function(){return g}});var s=o(7437),r=o(2265),n=o(5526);async function a(e){try{console.log("[DB] Checking if notes tables exist...");let t=await i(e),o=await l(e),s=await u(e);return t&&o&&s}catch(e){return console.error("[DB] Error checking/creating notes tables:",e),!1}}async function i(e){try{console.log("[DB] Checking if text_notes table exists...");let{error:t}=await e.from("text_notes").select("*",{count:"exact",head:!0}).limit(0);if(t){console.log("[DB] Text_notes table does not exist, creating it...");try{console.log("[DB] Attempting to create table via RPC...");let{error:t}=await e.rpc("create_text_notes_table",{});if(t)throw console.error("[DB] Error creating text_notes table via RPC:",t),Error("RPC failed, trying SQL approach");return console.log("[DB] Table created successfully via RPC"),!0}catch(e){return console.error("[DB] Error creating text_notes table:",e),!1}}return console.log("[DB] Text_notes table already exists"),!0}catch(e){return console.error("[DB] Error checking/creating text_notes table:",e),!1}}async function l(e){try{console.log("[DB] Checking if file_notes table exists...");let{error:t}=await e.from("file_notes").select("*",{count:"exact",head:!0}).limit(0);if(t){console.log("[DB] File_notes table does not exist, creating it...");try{console.log("[DB] Attempting to create table via RPC...");let{error:t}=await e.rpc("create_file_notes_table",{});if(t)throw console.error("[DB] Error creating file_notes table via RPC:",t),Error("RPC failed, trying SQL approach");return console.log("[DB] Table created successfully via RPC"),!0}catch(e){return console.error("[DB] Error creating file_notes table:",e),!1}}return console.log("[DB] File_notes table already exists"),!0}catch(e){return console.error("[DB] Error checking/creating file_notes table:",e),!1}}async function u(e){try{console.log("[DB] Checking if youtube_notes table exists...");let{error:t}=await e.from("youtube_notes").select("*",{count:"exact",head:!0}).limit(0);if(t){console.log("[DB] Youtube_notes table does not exist, creating it...");try{console.log("[DB] Attempting to create table via RPC...");let{error:t}=await e.rpc("create_youtube_notes_table",{});if(t)throw console.error("[DB] Error creating youtube_notes table via RPC:",t),Error("RPC failed, trying SQL approach");return console.log("[DB] Table created successfully via RPC"),!0}catch(e){return console.error("[DB] Error creating youtube_notes table:",e),!1}}return console.log("[DB] Youtube_notes table already exists"),!0}catch(e){return console.error("[DB] Error checking/creating youtube_notes table:",e),!1}}async function c(){console.log("[DB] Initializing database tables...");try{if(await a(n.supabase))return console.log("[DB] All database tables initialized successfully"),!0;{console.error("[DB] Failed to initialize all database tables"),console.log("[DB] Attempting to initialize tables individually");let e=await i(n.supabase);console.log("[DB] Text notes table initialization:",e?"success":"failed");let t=await l(n.supabase);console.log("[DB] File notes table initialization:",t?"success":"failed");let o=await u(n.supabase);return console.log("[DB] YouTube notes table initialization:",o?"success":"failed"),e||t||o}}catch(e){return console.error("[DB] Error initializing database:",e),!1}}let p=(0,r.createContext)({user:null,session:null,isLoading:!0,sessionError:null,refreshSession:async()=>null,supabase:n.supabase});function d(e){let{children:t}=e,[o,a]=(0,r.useState)(null),[i,l]=(0,r.useState)(null),[u,d]=(0,r.useState)(!0),[g,_]=(0,r.useState)(null),[f,h]=(0,r.useState)(0),b=async()=>{console.log("[Auth] Manually refreshing session state...");try{let{data:e,error:t}=await n.supabase.auth.refreshSession();if(t)return console.error("[Auth] Error refreshing session:",t.message),_(t.message),h(Date.now()),null;if(null==e?void 0:e.session)return console.log("[Auth] Session refreshed successfully:",{userId:e.session.user.id,expires:new Date(1e3*e.session.expires_at).toLocaleString()}),l(e.session),a(e.session.user),_(null),h(Date.now()),e.session;return console.log("[Auth] No session returned after refresh"),l(null),a(null),h(Date.now()),null}catch(e){return console.error("[Auth] Unexpected error during session refresh:",e),_(e instanceof Error?e.message:"Unknown error during session refresh"),h(Date.now()),null}};return(0,r.useEffect)(()=>{let e=!0;(async()=>{try{console.log("[Auth] Initializing auth state..."),d(!0);let{data:t,error:o}=await n.supabase.auth.getSession();if(o){console.error("[Auth] Error getting session:",o.message),e&&(_(o.message),d(!1));return}(null==t?void 0:t.session)?(console.log("[Auth] Initial session found for user:",{id:t.session.user.id,email:t.session.user.email,expires:new Date(1e3*t.session.expires_at).toISOString()}),e&&(l(t.session),a(t.session.user),c().then(e=>{console.log("[App] Database initialization:",e?"successful":"failed")}).catch(e=>{console.error("[App] Database initialization error:",e)}))):(console.log("[Auth] No active session found"),e&&(l(null),a(null))),e&&d(!1)}catch(t){console.error("[Auth] Unexpected error during auth initialization:",t),e&&(_(t instanceof Error?t.message:"Unknown error during auth initialization"),d(!1))}})();let{data:{subscription:t}}=n.supabase.auth.onAuthStateChange((t,o)=>{console.log("[Auth] Auth state change detected: ".concat(t)),e&&(o?(console.log("[Auth] New session established for user:",{id:o.user.id,email:o.user.email,expires:new Date(1e3*o.expires_at).toISOString()}),l(o),a(o.user),_(null)):(console.log("[Auth] Session cleared"),l(null),a(null)),d(!1))});return()=>{e=!1,t.unsubscribe()}},[f]),(0,s.jsx)(p.Provider,{value:{user:o,session:i,isLoading:u,sessionError:g,refreshSession:b,supabase:n.supabase},children:t})}let g=()=>{let e=(0,r.useContext)(p);if(void 0===e)throw Error("useSupabase must be used within a SupabaseProvider");return e}},5526:function(e,t,o){o.d(t,{supabase:function(){return r}});var s=o(3288);console.log("Supabase URL:","https://xhljckmlzdshxibnqsbj.supabase.co"),console.log("Supabase Anon Key exists:",!0);let r=(0,s.eI)("https://xhljckmlzdshxibnqsbj.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhobGpja21semRzaHhpYm5xc2JqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc4NDIwNzIsImV4cCI6MjA2MzQxODA3Mn0.UuU3QBxwY3-DsSpXB-UiKarjgZWiFAFIzFbgUqacmIA")}}]);