(()=>{var e={};e.id=1852,e.ids=[1852],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{"use strict";e.exports=require("buffer")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},98216:e=>{"use strict";e.exports=require("net")},68621:e=>{"use strict";e.exports=require("punycode")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},71568:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},74653:(e,r,t)=>{"use strict";t.r(r),t.d(r,{originalPathname:()=>j,patchFetch:()=>J,requestAsyncStorage:()=>g,routeModule:()=>d,serverHooks:()=>h,staticGenerationAsyncStorage:()=>_});var o={};t.r(o),t.d(o,{GET:()=>p});var s=t(49303),u=t(88716),a=t(60670),n=t(87070),i=t(20344),c=t(71615),l=t(30281);async function p(e){try{let r=(0,i.createRouteHandlerClient)({cookies:c.cookies}),{data:{user:t},error:o}=await r.auth.getUser();if(o||!t)return n.NextResponse.json({error:"Unauthorized"},{status:401});let s=e.nextUrl.searchParams,u="true"===s.get("global"),a=await l.h.getJobStats(u?void 0:t.id);if(!a)return n.NextResponse.json({error:"Failed to get job statistics"},{status:500});let p=await b(t.id);return n.NextResponse.json({success:!0,stats:a,queue:p})}catch(e){return console.error("[Jobs Stats API] Error getting stats:",e),n.NextResponse.json({success:!1,error:"Failed to get job stats",details:e.message},{status:500})}}async function b(e){try{let r=await l.h.getUserJobs(e,1,100),t=r.jobs.filter(e=>"queued"===e.status),o=r.jobs.filter(e=>"processing"===e.status),s=0;for(let e of t){let r=await l.h.getQueuePosition(e.id);s+=60*r}return{queuedCount:t.length,processingCount:o.length,estimatedWaitTimeSeconds:s,recentJobs:r.jobs.slice(0,5)}}catch(e){return console.error("[Jobs Stats API] Error getting queue info:",e),{queuedCount:0,processingCount:0,estimatedWaitTimeSeconds:0,recentJobs:[]}}}let d=new s.AppRouteRouteModule({definition:{kind:u.x.APP_ROUTE,page:"/api/jobs/stats/route",pathname:"/api/jobs/stats",filename:"route",bundlePath:"app/api/jobs/stats/route"},resolvedPagePath:"/Users/janjedrach/Cursor/eduscribe/src/app/api/jobs/stats/route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:_,serverHooks:h}=d,j="/api/jobs/stats/route";function J(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:_})}},30281:(e,r,t)=>{"use strict";t.d(r,{h:()=>u});var o=t(23517);class s{constructor(){let e="https://xhljckmlzdshxibnqsbj.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e)throw Error("NEXT_PUBLIC_SUPABASE_URL is required");let t=r||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhobGpja21semRzaHhpYm5xc2JqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc4NDIwNzIsImV4cCI6MjA2MzQxODA3Mn0.UuU3QBxwY3-DsSpXB-UiKarjgZWiFAFIzFbgUqacmIA";if(!t)throw Error("Either SUPABASE_SERVICE_ROLE_KEY or NEXT_PUBLIC_SUPABASE_ANON_KEY is required");this.supabase=(0,o.eI)(e,t)}async enqueueJob(e,r,t,o){try{console.log(`[JobQueue] Enqueueing ${r} job for user ${e}`);let{data:s,error:u}=await this.supabase.rpc("enqueue_job",{p_user_id:e,p_job_type:r,p_input_data:t,p_estimated_duration_seconds:o});if(u)throw console.error("[JobQueue] Error enqueueing job:",u),Error(`Failed to enqueue job: ${u.message}`);let a=await this.getQueuePosition(s);return console.log(`[JobQueue] Job ${s} enqueued at position ${a}`),{jobId:s,position:a}}catch(e){throw console.error("[JobQueue] Error in enqueueJob:",e),e}}async getNextJob(e){try{let{data:r,error:t}=await this.supabase.rpc("get_next_job",{p_worker_id:e});if(t)return console.error("[JobQueue] Error getting next job:",t),null;if(!r||!Array.isArray(r)||0===r.length)return null;let o=r[0];return console.log(`[JobQueue] Retrieved job ${o.job_id} for processing`),{id:o.job_id,user_id:o.user_id,job_type:o.job_type,priority:o.priority,input_data:o.input_data,created_at:o.created_at,status:"processing",progress:0,retry_count:0,max_retries:3,updated_at:new Date().toISOString()}}catch(e){return console.error("[JobQueue] Error in getNextJob:",e),null}}async updateJobProgress(e,r,t){try{let{data:o,error:s}=await this.supabase.rpc("update_job_progress",{p_job_id:e,p_progress:r,p_status:t});if(s)return console.error("[JobQueue] Error updating job progress:",s),!1;return console.log(`[JobQueue] Updated job ${e} progress to ${r}%`),!!o}catch(e){return console.error("[JobQueue] Error in updateJobProgress:",e),!1}}async completeJob(e,r,t=!0,o,s){try{let{data:u,error:a}=await this.supabase.rpc("complete_job",{p_job_id:e,p_output_data:r,p_success:t,p_error_message:o,p_error_details:s});if(a)return console.error("[JobQueue] Error completing job:",a),!1;return console.log(`[JobQueue] Job ${e} completed with status: ${t?"success":"failure"}`),!!u}catch(e){return console.error("[JobQueue] Error in completeJob:",e),!1}}async retryJob(e){try{let{data:r,error:t}=await this.supabase.rpc("retry_job",{p_job_id:e});if(t)return console.error("[JobQueue] Error retrying job:",t),!1;return console.log(`[JobQueue] Job ${e} retried`),!!r}catch(e){return console.error("[JobQueue] Error in retryJob:",e),!1}}async getJob(e){try{let{data:r,error:t}=await this.supabase.from("jobs").select("*").eq("id",e).single();if(t)return console.error("[JobQueue] Error getting job:",t),null;return r}catch(e){return console.error("[JobQueue] Error in getJob:",e),null}}async getUserJobs(e,r=1,t=10,o){try{let s=this.supabase.from("jobs").select("*",{count:"exact"}).eq("user_id",e).order("created_at",{ascending:!1});o&&(s=s.eq("status",o));let{data:u,error:a,count:n}=await s.range((r-1)*t,r*t-1);if(a)return console.error("[JobQueue] Error getting user jobs:",a),{jobs:[],total:0,hasMore:!1};let i=n||0;return{jobs:u||[],total:i,hasMore:r*t<i}}catch(e){return console.error("[JobQueue] Error in getUserJobs:",e),{jobs:[],total:0,hasMore:!1}}}async getQueuePosition(e){try{let{data:r}=await this.supabase.from("jobs").select("priority, created_at").eq("id",e).single();if(!r)return -1;let{count:t}=await this.supabase.from("jobs").select("*",{count:"exact",head:!0}).eq("status","queued").or(`priority.gt.${r.priority},and(priority.eq.${r.priority},created_at.lt.${r.created_at})`);return(t||0)+1}catch(e){return console.error("[JobQueue] Error getting queue position:",e),-1}}async getJobStats(e){try{let{data:r,error:t}=await this.supabase.rpc("get_job_stats",{p_user_id:e});if(t)return console.error("[JobQueue] Error getting job stats:",t),null;if(!r||!Array.isArray(r)||0===r.length)return null;return r[0]}catch(e){return console.error("[JobQueue] Error in getJobStats:",e),null}}async cancelJob(e){try{let{error:r}=await this.supabase.from("jobs").update({status:"cancelled",updated_at:new Date().toISOString()}).eq("id",e).in("status",["queued"]);if(r)return console.error("[JobQueue] Error cancelling job:",r),!1;return console.log(`[JobQueue] Job ${e} cancelled`),!0}catch(e){return console.error("[JobQueue] Error in cancelJob:",e),!1}}subscribeToJobUpdates(e,r){return this.supabase.channel("job_updates").on("postgres_changes",{event:"*",schema:"public",table:"jobs",filter:`user_id=eq.${e}`},r).subscribe()}async cleanupOldJobs(e=30){try{let r=new Date;r.setDate(r.getDate()-e);let{data:t,error:o}=await this.supabase.from("jobs").delete().in("status",["completed","failed","cancelled"]).lt("completed_at",r.toISOString());if(o)return console.error("[JobQueue] Error cleaning up old jobs:",o),0;let s=t?.length||0;return console.log(`[JobQueue] Cleaned up ${s} old jobs`),s}catch(e){return console.error("[JobQueue] Error in cleanupOldJobs:",e),0}}}let u=new s}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[9276,5972,3517,958],()=>t(74653));module.exports=o})();