(()=>{var e={};e.id=446,e.ids=[446],e.modules={20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{"use strict";e.exports=require("buffer")},61282:e=>{"use strict";e.exports=require("child_process")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},98216:e=>{"use strict";e.exports=require("net")},68621:e=>{"use strict";e.exports=require("punycode")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},56475:(e,r,t)=>{"use strict";t.r(r),t.d(r,{originalPathname:()=>I,patchFetch:()=>S,requestAsyncStorage:()=>d,routeModule:()=>l,serverHooks:()=>b,staticGenerationAsyncStorage:()=>_});var s={};t.r(s),t.d(s,{POST:()=>p});var i=t(49303),n=t(88716),o=t(60670),a=t(87070),c=t(46029),u=t(23517);async function p(e){try{console.log("[Stripe Cancel] Processing subscription cancellation...");let r="https://xhljckmlzdshxibnqsbj.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhobGpja21semRzaHhpYm5xc2JqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc4NDIwNzIsImV4cCI6MjA2MzQxODA3Mn0.UuU3QBxwY3-DsSpXB-UiKarjgZWiFAFIzFbgUqacmIA";if(!r||!t)return console.error("[Stripe Cancel] Missing Supabase environment variables:",{supabaseUrl:!!r,supabaseAnonKey:!!t}),a.NextResponse.json({error:"Server configuration error - missing Supabase credentials"},{status:500});let s=e.headers.get("authorization");if(!s||!s.startsWith("Bearer "))return console.error("[Stripe Cancel] Authentication missing"),a.NextResponse.json({error:"Authentication required"},{status:401});let i=s.substring(7),n=(0,u.eI)(r,t),{data:{user:o},error:p}=await n.auth.getUser(i);if(p||!o)return console.error("[Stripe Cancel] Invalid user token:",p),a.NextResponse.json({error:"Invalid authentication"},{status:401});let{subscriptionId:l}=await e.json();if(!l)return a.NextResponse.json({error:"Subscription ID is required"},{status:400});console.log("[Stripe Cancel] Cancelling subscription for user:",o.id,"subscription:",l);let d=(0,c.kJ)(),_=await d.subscriptions.retrieve(l);if(!_.metadata?.userId||_.metadata.userId!==o.id)return console.error("[Stripe Cancel] Subscription does not belong to user"),a.NextResponse.json({error:"Unauthorized subscription access"},{status:403});let b=await d.subscriptions.update(l,{cancel_at_period_end:!0});console.log("[Stripe Cancel] Subscription cancelled in Stripe:",{id:b.id,status:b.status,cancel_at_period_end:b.cancel_at_period_end});let I=(0,u.eI)(r,t,{global:{headers:{Authorization:`Bearer ${i}`}}}),{error:S}=await I.from("user_subscriptions").update({cancel_at_period_end:!0,updated_at:new Date().toISOString()}).eq("user_id",o.id).eq("stripe_subscription_id",l);return S?console.error("[Stripe Cancel] Error updating subscription in database:",S):console.log("[Stripe Cancel] Successfully updated subscription in database"),a.NextResponse.json({success:!0,message:"Subscription cancelled successfully",subscription:{id:b.id,status:b.status,cancel_at_period_end:b.cancel_at_period_end}})}catch(e){if(console.error("[Stripe Cancel] Error cancelling subscription:",e),e.type)return a.NextResponse.json({error:"Stripe error: "+e.message,type:e.type},{status:400});return a.NextResponse.json({error:"Failed to cancel subscription",details:e.message},{status:500})}}let l=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/stripe/cancel-subscription/route",pathname:"/api/stripe/cancel-subscription",filename:"route",bundlePath:"app/api/stripe/cancel-subscription/route"},resolvedPagePath:"/Users/janjedrach/Cursor/eduscribe/src/app/api/stripe/cancel-subscription/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:d,staticGenerationAsyncStorage:_,serverHooks:b}=l,I="/api/stripe/cancel-subscription/route";function S(){return(0,o.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:_})}},46029:(e,r,t)=>{"use strict";let s;t.d(r,{kJ:()=>n,rg:()=>o});var i=t(31059);let n=()=>{if(!s){let e=process.env.STRIPE_SECRET_KEY;if(!e)throw Error("STRIPE_SECRET_KEY is not defined in environment variables");s=new i.Z(e,{apiVersion:"2025-05-28.basil",appInfo:{name:"EduScribe",version:"1.0.0"}})}return s},o={student:{monthly:process.env.STRIPE_STUDENT_MONTHLY_PRICE_ID||"price_student_monthly",yearly:process.env.STRIPE_STUDENT_YEARLY_PRICE_ID||"price_student_yearly"},pro:{monthly:process.env.STRIPE_PRO_MONTHLY_PRICE_ID||"price_pro_monthly",yearly:process.env.STRIPE_PRO_YEARLY_PRICE_ID||"price_pro_yearly"}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[9276,5972,3517,2749,1059],()=>t(56475));module.exports=s})();