(()=>{var e={};e.id=446,e.ids=[446],e.modules={20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{"use strict";e.exports=require("buffer")},61282:e=>{"use strict";e.exports=require("child_process")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},98216:e=>{"use strict";e.exports=require("net")},68621:e=>{"use strict";e.exports=require("punycode")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},56475:(e,r,t)=>{"use strict";t.r(r),t.d(r,{originalPathname:()=>I,patchFetch:()=>b,requestAsyncStorage:()=>d,routeModule:()=>l,serverHooks:()=>S,staticGenerationAsyncStorage:()=>_});var s={};t.r(s),t.d(s,{POST:()=>p});var n=t(49303),i=t(88716),o=t(60670),a=t(87070),c=t(46029),u=t(23517);async function p(e){console.log("[Cancel] Starting subscription cancellation...");try{let r;let{subscriptionId:t}=await e.json();if(!t)return console.error("[Cancel] No subscription ID provided"),a.NextResponse.json({error:"Subscription ID is required"},{status:400});console.log("[Cancel] Attempting to cancel subscription:",t);let s=e.headers.get("authorization");if(!s||!s.startsWith("Bearer "))return console.error("[Cancel] No authorization header"),a.NextResponse.json({error:"Authentication required"},{status:401});let n=s.substring(7),i="https://xhljckmlzdshxibnqsbj.supabase.co",o="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhobGpja21semRzaHhpYm5xc2JqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc4NDIwNzIsImV4cCI6MjA2MzQxODA3Mn0.UuU3QBxwY3-DsSpXB-UiKarjgZWiFAFIzFbgUqacmIA";if(!i||!o)return console.error("[Cancel] Missing Supabase configuration"),a.NextResponse.json({error:"Server configuration error"},{status:500});let p=(0,u.eI)(i,o),{data:{user:l},error:d}=await p.auth.getUser(n);if(d||!l)return console.error("[Cancel] Invalid user token:",d?.message),a.NextResponse.json({error:"Invalid authentication"},{status:401});console.log("[Cancel] User authenticated:",l.id);let _=(0,c.kJ)();if(!_)return console.error("[Cancel] Failed to initialize Stripe"),a.NextResponse.json({error:"Stripe configuration error"},{status:500});console.log("[Cancel] Cancelling subscription in Stripe...");try{console.log("[Cancel] Retrieving subscription from Stripe first...");let e=await _.subscriptions.retrieve(t);if(console.log("[Cancel] Found subscription in Stripe:",{id:e.id,status:e.status,customer:e.customer,cancel_at_period_end:e.cancel_at_period_end,current_period_end:e.current_period_end}),"canceled"===e.status)return console.log("[Cancel] Subscription already cancelled in Stripe"),a.NextResponse.json({success:!0,message:"Subscription was already cancelled",subscription:{id:t,status:e.status,cancel_at_period_end:e.cancel_at_period_end,current_period_end:e.current_period_end?new Date(1e3*e.current_period_end).toISOString():null}});if(e.cancel_at_period_end)return console.log("[Cancel] Subscription already set to cancel at period end"),a.NextResponse.json({success:!0,message:"Subscription is already set to cancel at period end",subscription:{id:t,status:e.status,cancel_at_period_end:e.cancel_at_period_end,current_period_end:e.current_period_end?new Date(1e3*e.current_period_end).toISOString():null}});console.log("[Cancel] Updating subscription to cancel at period end..."),r=await _.subscriptions.update(t,{cancel_at_period_end:!0}),console.log("[Cancel] Stripe cancellation successful:",{id:r.id,status:r.status,cancel_at_period_end:r.cancel_at_period_end,current_period_end:r.current_period_end})}catch(s){console.error("[Cancel] Stripe operation failed:",{message:s.message,type:s.type,code:s.code,statusCode:s.statusCode,requestId:s.requestId,decline_code:s.decline_code,param:s.param});let e="Failed to cancel subscription in Stripe",r=400;return"StripeInvalidRequestError"===s.type?"resource_missing"===s.code?(e="Subscription not found in Stripe",r=404):e="subscription_update_failed"===s.code?"Subscription cannot be updated":`Invalid request: ${s.message}`:"StripeAPIError"===s.type?(e="Stripe API error - please try again later",r=503):"StripeConnectionError"===s.type?(e="Connection error with Stripe - please try again",r=503):"StripeAuthenticationError"===s.type&&(e="Stripe authentication error",r=500),a.NextResponse.json({error:e,details:s.message,stripeErrorType:s.type,stripeErrorCode:s.code,subscriptionId:t},{status:r})}try{let e=process.env.NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY||o,r=(0,u.eI)(i,e),{error:s}=await r.from("user_subscriptions").update({cancel_at_period_end:!0,cancelled_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("stripe_subscription_id",t).eq("user_id",l.id);s?console.warn("[Cancel] Database update failed (but Stripe succeeded):",s.message):console.log("[Cancel] Database updated successfully")}catch(e){console.warn("[Cancel] Database update error (but Stripe succeeded):",e)}return a.NextResponse.json({success:!0,message:"Subscription cancelled successfully",subscription:{id:t,status:r.status,cancel_at_period_end:r.cancel_at_period_end,current_period_end:r?.current_period_end?new Date(1e3*r.current_period_end).toISOString():null}})}catch(e){return console.error("[Cancel] Unexpected error:",e),a.NextResponse.json({error:"Internal server error",details:e.message},{status:500})}}let l=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/stripe/cancel-subscription/route",pathname:"/api/stripe/cancel-subscription",filename:"route",bundlePath:"app/api/stripe/cancel-subscription/route"},resolvedPagePath:"/Users/janjedrach/Cursor/eduscribe/src/app/api/stripe/cancel-subscription/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:d,staticGenerationAsyncStorage:_,serverHooks:S}=l,I="/api/stripe/cancel-subscription/route";function b(){return(0,o.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:_})}},46029:(e,r,t)=>{"use strict";let s;t.d(r,{kJ:()=>i,rg:()=>o});var n=t(31059);let i=()=>{if(!s){let e=process.env.STRIPE_SECRET_KEY;if(!e)throw Error("STRIPE_SECRET_KEY is not defined in environment variables");s=new n.Z(e,{apiVersion:"2025-05-28.basil",appInfo:{name:"EduScribe",version:"1.0.0"}})}return s},o={student:{monthly:process.env.STRIPE_STUDENT_MONTHLY_PRICE_ID||"price_student_monthly",yearly:process.env.STRIPE_STUDENT_YEARLY_PRICE_ID||"price_student_yearly"},pro:{monthly:process.env.STRIPE_PRO_MONTHLY_PRICE_ID||"price_pro_monthly",yearly:process.env.STRIPE_PRO_YEARLY_PRICE_ID||"price_pro_yearly"}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[9276,5972,3517,2749,1059],()=>t(56475));module.exports=s})();